<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take TOEIC Test - Toeic Mentor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .question-container {
            margin-bottom: 2rem;
        }

        .passage-container {
            background-color: #f8f9fa;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .option-label {
            display: block;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-label:hover {
            background-color: #e9ecef;
        }

        .option-input:checked + .option-label {
            background-color: #cfe2ff;
            border-color: #3b82f6;
        }

        .option-input {
            display: none;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-container {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
            text-align: center;
        }

        .question-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .question-nav-button {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            font-weight: 500;
            cursor: pointer;
        }

        .question-nav-button:hover {
            background-color: #e9ecef;
        }

        .question-nav-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .question-nav-button.answered {
            background-color: #a7f3d0;
            border-color: #10b981;
        }

        .image-container {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .image-container img {
            max-width: 90vw;
            max-height: 600px;
            width: auto;
            height: auto;
            border-radius: 0.5rem;
        }

        .streamed-line {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
        }

        .flag-button {
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: #9ca3af;
            transition: all 0.2s;
            cursor: pointer;
        }

        .flag-button:hover {
            color: #f59e0b;
        }

        .flag-button.flagged {
            color: #f59e0b;
        }

        .question-nav-button.flagged {
            border: 2px solid #f59e0b;
            position: relative;
        }

        .question-nav-button.flagged::after {
            content: '‚≠ê';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 12px;
            color: #f59e0b;
        }

        .flagged-questions-review {
            background-color: #fff7ed;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .result-correct {
            border: 2px solid #22c55e;
            background-color: #dcfce7;
        }

        .result-wrong {
            border: 2px solid #ef4444;
            background-color: #fee2e2;
        }

        /* Add new styles for the view toggle */
        .view-toggle {
            display: inline-flex;
            align-items: center;
            background-color: #e5e7eb;
            border-radius: 9999px;
            padding: 2px;
            cursor: pointer;
            user-select: none;
        }

        .view-toggle-option {
            padding: 6px 12px;
            border-radius: 9999px;
            transition: all 0.2s;
        }

        .view-toggle-option.active {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .detail-section {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="container mx-auto py-4 px-4">
    <h1 class="text-2xl font-bold mb-4 text-center">TOEIC Practice Test</h1>

    <!-- Timer -->
    <div class="timer-container mb-4">
        <div class="text-lg font-semibold">Time Remaining: <span id="timer">120:00</span></div>
    </div>

    <!-- Question Navigation -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold mb-2">Question Navigation:</h3>
        <div class="question-navigation" id="questionNav">
            <!-- Will be filled by JavaScript -->
        </div>
    </div>

    <div class="flex flex-wrap">
        <!-- Main Content -->
        <div class="w-full lg:w-3/4 lg:pr-4">
            <form id="testForm">
                <div id="questionsContainer">
                    <!-- Questions will be rendered here -->
                </div>

                <div class="flex justify-between mt-8 mb-12">
                    <button type="button" id="prevBtn"
                            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Previous
                    </button>
                    <button type="button" id="nextBtn"
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Next
                    </button>
                </div>

                <!-- Add flagged questions review panel before the submit button -->
                <div class="flagged-questions-review hidden" id="flaggedQuestionsPanel">
                    <h4 class="font-semibold mb-2">Flagged Questions:</h4>
                    <div id="flaggedQuestionsList" class="space-y-2">
                        <!-- Flagged questions will be listed here -->
                    </div>
                </div>

                <div class="text-center mb-12">
                    <button type="button" id="submitBtn"
                            class="bg-green-600 text-white px-6 py-3 rounded text-lg font-semibold hover:bg-green-700">
                        Submit Test
                    </button>
                </div>
            </form>
        </div>

        <!-- Sidebar - Part Information -->
        <div class="w-full lg:w-1/4 lg:pl-4">
            <div class="bg-white p-4 rounded-lg shadow mb-4 sticky top-24">
                <h3 class="text-lg font-semibold mb-3">Test Information</h3>
                <div class="mb-2">
                    <span class="font-medium">Total Questions:</span>
                    <span id="totalQuestions">0</span>
                </div>
                <div class="mb-2">
                    <span class="font-medium">Answered:</span>
                    <span id="answeredCount">0</span>
                </div>
                <div class="mb-2">
                    <span class="font-medium">Remaining:</span>
                    <span id="remainingCount">0</span>
                </div>
                <hr class="my-3">
                <div>
                    <h4 class="font-semibold mb-2">Part Information:</h4>
                    <ul class="list-disc pl-5">
                        <li>Part 1: Photographs</li>
                        <li>Part 2: Question-Response</li>
                        <li>Part 3: Conversations</li>
                        <li>Part 4: Short Talks</li>
                        <li>Part 5: Incomplete Sentences</li>
                        <li>Part 6: Text Completion</li>
                        <li>Part 7: Reading Comprehension</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" id="confirmationModal">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
        <h3 class="text-xl font-bold mb-4">Submit Test?</h3>
        <p class="mb-6">Are you sure you want to submit your test? You have answered <span
                id="modalAnsweredCount">0</span> out of <span id="modalTotalQuestions">0</span> questions.</p>
        <div class="flex justify-end space-x-3">
            <button id="cancelSubmit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cancel
            </button>
            <button id="confirmSubmit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Submit
            </button>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" id="resultModal">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full">
        <h3 class="text-2xl font-bold mb-4 text-center">Test Results</h3>
        <div class="mb-4">
            <div class="flex justify-between mb-2">
                <span class="font-medium">Score:</span>
                <span id="scoreDisplay" class="font-bold text-xl">0/0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="bg-blue-600 h-4 rounded-full" id="scoreProgressBar" style="width: 0%"></div>
            </div>
        </div>
        <div class="mb-6">
            <h4 class="font-semibold mb-2">Score Breakdown:</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <span class="font-medium">Listening Section:</span>
                    <span id="listeningScore">0/0</span>
                </div>
                <div>
                    <span class="font-medium">Reading Section:</span>
                    <span id="readingScore">0/0</span>
                </div>
            </div>
        </div>
        <div class="text-center">
            <button id="reviewTestBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mr-3">Review
                Test
            </button>
            <button id="backToDashboardBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Back
                to Dashboard
            </button>
        </div>
    </div>
</div>

<!-- Report Question Modal -->
<div id="reportModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
        <button id="closeReportModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;
        </button>
        <h2 class="text-lg font-bold mb-4">Report Question</h2>
        <form id="reportForm" class="space-y-4">
            <input type="hidden" id="reportQuestionId" name="questionId">
            <div>
                <label for="reportCategory" class="block font-medium mb-1">Category <span class="text-red-500">*</span></label>
                <select id="reportCategory" name="category" class="w-full border rounded px-3 py-2" required>
                    <option value="">-- Select Category --</option>
                    <option value="WRONG_QUESTION">Wrong Question</option>
                    <option value="TYPING_ERROR">Typing Error</option>
                    <option value="UNCLEAR_ANSWER">Unclear Answer</option>
                    <option value="OTHER">Other</option>
                </select>
                <div id="categoryError" class="text-red-500 text-sm hidden">Please select a category.</div>
            </div>
            <div>
                <label for="reportDescription" class="block font-medium mb-1">Description <span
                        class="text-red-500">*</span></label>
                <textarea id="reportDescription" name="description" rows="3" class="w-full border rounded px-3 py-2"
                          required></textarea>
                <div id="descriptionError" class="text-red-500 text-sm hidden">Please enter a description.</div>
            </div>
            <div id="reportFormMsg" class="text-sm mb-2"></div>
            <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded w-full">Submit
                Report
            </button>
        </form>
    </div>
</div>

<!-- Scripts -->

<script th:inline="javascript">
    // Get questions data from Thymeleaf
    const questions = /*[[${questions}]]*/ [];
    // Set default test duration (2 hours) if not provided
    const testDuration = 120; // in minutes
</script>

<script>
    // Global variables
    let currentQuestionIndex = 0;
    const userAnswers = {};
    const flaggedQuestions = new Set();
    let timerInterval;
    let timeRemaining = testDuration * 60;
    let questionStartTime = Date.now(); // Track when user starts a question
    const timeSpentOnQuestions = {}; // Track time spent on each question

    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', function () {
        questionStartTime = Date.now(); // Initialize start time
        // Set up questions
        renderQuestions();
        updateQuestionNavigation();
        updateCurrentQuestion();
        updateSidebarCounts();
        startTimer();

        // Set up event listeners
        document.getElementById('nextBtn').addEventListener('click', goToNextQuestion);
        document.getElementById('prevBtn').addEventListener('click', goToPrevQuestion);
        document.getElementById('submitBtn').addEventListener('click', function () {
            updateFlaggedQuestionsPanel();
            showConfirmationModal();
        });
        document.getElementById('cancelSubmit').addEventListener('click', hideConfirmationModal);
        document.getElementById('confirmSubmit').addEventListener('click', submitTest);
        document.getElementById('reviewTestBtn').addEventListener('click', hideResultModal);
        document.getElementById('backToDashboardBtn').addEventListener('click', goToDashboard);

        // Add event listener for flag buttons
        document.addEventListener('click', function (e) {
            if (e.target.closest('.flag-button')) {
                const button = e.target.closest('.flag-button');
                const questionIndex = parseInt(button.dataset.question);
                toggleQuestionFlag(questionIndex);
            }
        });
    });

    // Toggle flag status for a question
    function toggleQuestionFlag(questionIndex) {
        const flagButton = document.querySelector(`.flag-button[data-question="${questionIndex}"]`);
        const navButton = document.querySelectorAll('.question-nav-button')[questionIndex];

        if (flaggedQuestions.has(questionIndex)) {
            flaggedQuestions.delete(questionIndex);
            flagButton.classList.remove('flagged');
            navButton.classList.remove('flagged');
        } else {
            flaggedQuestions.add(questionIndex);
            flagButton.classList.add('flagged');
            navButton.classList.add('flagged');
        }

        updateFlaggedQuestionsPanel();
    }

    // Update the flagged questions review panel
    function updateFlaggedQuestionsPanel() {
        const panel = document.getElementById('flaggedQuestionsPanel');
        const list = document.getElementById('flaggedQuestionsList');

        if (flaggedQuestions.size > 0) {
            list.innerHTML = '';
            Array.from(flaggedQuestions).sort((a, b) => a - b).forEach(index => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow-sm';
                div.innerHTML = `
                    <span>Question ${index + 1}</span>
                    <button type="button" class="text-blue-600 hover:text-blue-800" onclick="goToQuestion(${index})">
                        Review
                    </button>
                `;
                list.appendChild(div);
            });
            panel.classList.remove('hidden');
        } else {
            panel.classList.add('hidden');
        }
    }

    // Modified renderQuestions to include flag button
    function renderQuestions() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        questions.forEach((question, index) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'question-container';
            questionElement.id = `question-${index}`;
            questionElement.dataset.part = question.part;

            // Create question header with flag and report button
            const questionHeader = document.createElement('div');
            questionHeader.className = 'question-header mb-3';
            questionHeader.innerHTML = `
                <div class="flex items-center">
                    <h3 class="text-xl font-semibold mr-4">Question ${index + 1}</h3>
                    <span class="badge bg-primary">Part ${question.part}</span>
                    ${question.difficulty ? `
                    <span class="ml-2 px-2 py-1 rounded text-sm font-medium ${
                        question.difficulty <= 2 ? 'bg-green-100 text-green-800' :
                        question.difficulty <= 4 ? 'bg-yellow-100 text-yellow-800' :
                        'bg-red-100 text-red-800'
                    }">
                        Difficulty: ${question.difficulty}/5
                    </span>` : ''}
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" class="flag-button" data-question="${index}">
                        <i class="fas fa-star"></i>
                    </button>
                    <button type="button" class="report-button text-red-500 hover:text-red-700" data-question="${index}" data-questionid="${question.id}" title="Report this question">
                        <i class="fas fa-flag"></i>
                    </button>
                </div>
            `;

            // Add tags if they exist
            if (question.tags && question.tags.length > 0) {
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'flex flex-wrap gap-2 mt-2';
                tagsContainer.innerHTML = question.tags.map(tag =>
                    `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">${tag}</span>`
                ).join('');
                questionHeader.appendChild(tagsContainer);
            }

            // Create passage container if a passage exists
            let passageHtml = '';
            if (question.passage) {
                passageHtml = `
                    <div class="passage-container">
                        <h4 class="font-semibold mb-2">Passage:</h4>
                        <div class="passage-text">${question.passage}</div>
                    </div>
                `;
            }

            // Create image container if an image URL or list exists
            let imageHtml = '';
            if (Array.isArray(question.passageImageUrls) && question.passageImageUrls.length > 0) {
                imageHtml = `
                    <div class="image-container" style="display: flex; flex-direction: row; gap: 32px; justify-content: center; align-items: flex-start; overflow-x: auto;">
                        ${question.passageImageUrls.map(url => `<img src="${url}" alt="Question Image" style="margin-bottom: 0; max-width: 1000px; max-height: 700px; width: auto; height: auto; object-fit: contain;" />`).join('')}
                    </div>
                `;
            }

            // Create question text
            const questionText = `<div class="mb-4">${question.questionText}</div>`;

            // Create options
            let optionsHtml = '<div class="options-container">';
            question.options.forEach(option => {
                optionsHtml += `
                    <div class="mb-2">
                        <input type="radio" name="question-${index}" id="q${index}-${option.key}"
                            value="${option.key}" class="option-input">
                        <label for="q${index}-${option.key}" class="option-label">
                            <span class="font-medium">${option.key}:</span> ${option.value}
                        </label>
                    </div>
                `;
            });
            optionsHtml += '</div>';

            // Assemble the question element
            questionElement.innerHTML = questionHeader.outerHTML + passageHtml + imageHtml + questionText + optionsHtml;

            // Add event listeners for the radio buttons
            questionElement.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    // Store answer in userAnswers object for UI tracking
                    userAnswers[index] = e.target.value;

                    // Set the userAnswer field directly in the QuestionResponse object
                    questions[index].userAnswer = e.target.value;

                    updateQuestionNavigation();
                    updateSidebarCounts();
                });
            });

            // Add event listener for the report button
            const reportBtn = questionElement.querySelector('.report-button');
            if (reportBtn) {
                reportBtn.addEventListener('click', function () {
                    const qid = this.getAttribute('data-questionid');
                    document.getElementById('reportQuestionId').value = qid;
                    document.getElementById('reportCategory').value = '';
                    document.getElementById('categoryError').classList.add('hidden');
                    document.getElementById('reportModal').classList.remove('hidden');
                });
            }

            // Initially hide the question
            questionElement.style.display = 'none';
            container.appendChild(questionElement);
        });

        // Update total questions count
        document.getElementById('totalQuestions').textContent = questions.length;
        document.getElementById('modalTotalQuestions').textContent = questions.length;
        document.getElementById('remainingCount').textContent = questions.length;
    }

    // Update the question navigation buttons
    function updateQuestionNavigation() {
        const nav = document.getElementById('questionNav');
        nav.innerHTML = '';

        questions.forEach((_, index) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `question-nav-button ${index === currentQuestionIndex ? 'active' : ''}
                              ${userAnswers[index] ? 'answered' : ''}
                              ${flaggedQuestions.has(index) ? 'flagged' : ''}`;
            button.textContent = index + 1;

            button.addEventListener('click', () => {
                goToQuestion(index);
            });

            nav.appendChild(button);
        });
    }

    // Modified updateCurrentQuestion to preserve flag status
    function updateCurrentQuestion() {
        // Hide all questions
        document.querySelectorAll('.question-container').forEach(question => {
            question.style.display = 'none';
        });

        // Show the current question
        const currentQuestion = document.getElementById(`question-${currentQuestionIndex}`);
        if (currentQuestion) {
            currentQuestion.style.display = 'block';
        }

        // Update navigation buttons
        document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
        document.getElementById('nextBtn').disabled = currentQuestionIndex === questions.length - 1;

        // Update active state in navigation and preserve flag status
        document.querySelectorAll('.question-nav-button').forEach((button, index) => {
            button.classList.toggle('active', index === currentQuestionIndex);
        });

        // Update flag button status for current question
        const flagButton = document.querySelector(`.flag-button[data-question="${currentQuestionIndex}"]`);
        if (flagButton) {
            flagButton.classList.toggle('flagged', flaggedQuestions.has(currentQuestionIndex));
        }
    }

    // Function to update time spent on current question
    function updateTimeSpentOnCurrentQuestion() {
        const currentTime = Date.now();
        const timeSpent = Math.floor((currentTime - questionStartTime) / 1000); // Convert to seconds
        timeSpentOnQuestions[currentQuestionIndex] = (timeSpentOnQuestions[currentQuestionIndex] || 0) + timeSpent;
        questions[currentQuestionIndex].timeSpent = timeSpentOnQuestions[currentQuestionIndex];
        questionStartTime = currentTime; // Reset start time for next question
    }

    // Go to a specific question
    function goToQuestion(index) {
        if (index >= 0 && index < questions.length) {
            updateTimeSpentOnCurrentQuestion(); // Record time spent on current question
            currentQuestionIndex = index;
            updateCurrentQuestion();
        }
    }

    // Go to the next question
    function goToNextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            updateTimeSpentOnCurrentQuestion(); // Record time spent on current question
            currentQuestionIndex++;
            updateCurrentQuestion();
        }
    }

    // Go to the previous question
    function goToPrevQuestion() {
        if (currentQuestionIndex > 0) {
            updateTimeSpentOnCurrentQuestion(); // Record time spent on current question
            currentQuestionIndex--;
            updateCurrentQuestion();
        }
    }

    // Update sidebar statistics
    function updateSidebarCounts() {
        const answeredCount = Object.keys(userAnswers).length;
        const totalQuestions = questions.length;
        const remainingCount = totalQuestions - answeredCount;

        document.getElementById('answeredCount').textContent = answeredCount;
        document.getElementById('remainingCount').textContent = remainingCount;
        document.getElementById('modalAnsweredCount').textContent = answeredCount;
    }

    // Timer functions
    function startTimer() {
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                submitTest();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.getElementById('timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Modal functions
    function showConfirmationModal() {
        document.getElementById('confirmationModal').classList.remove('hidden');
    }

    function hideConfirmationModal() {
        document.getElementById('confirmationModal').classList.add('hidden');
    }

    function showResultModal() {
        document.getElementById('resultModal').classList.remove('hidden');
    }

    function hideResultModal() {
        document.getElementById('resultModal').classList.add('hidden');
    }

    // Submit test function
    function submitTest() {
        updateTimeSpentOnCurrentQuestion(); // Record time spent on final question
        // Check if all questions are answered
        const unanswered = Array.from(document.querySelectorAll('.question-container')).some(qBlock => {
            return !qBlock.querySelector('input[type="radio"]:checked');
        });
        if (unanswered) {
            alert('Please answer all questions before submitting the test.');
            return;
        }
        clearInterval(timerInterval);
        hideConfirmationModal();

        // Gather user answers
        const answerRequests = [];
        document.querySelectorAll('.question-container').forEach((qBlock, idx) => {
            const selectedOption = qBlock.querySelector('input[type="radio"]:checked');
            // Copy all fields from the original question object
            const question = questions[idx];
            answerRequests.push({
                ...question,
                userAnswer: selectedOption ? selectedOption.value : null
            });
        });

        // Show loading UI
        const analysisContainer = document.createElement('div');
        analysisContainer.className = 'bg-white p-6 rounded-lg shadow-lg mt-4 mb-8';
        analysisContainer.innerHTML = `
            <h3 class="text-xl font-bold mb-4">Test Analysis</h3>
            <div id="analysis-content" class="message-content"></div>
            <div class="mt-4 text-center hidden" id="back-to-dashboard-container">
                <button id="analysis-dashboard-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    Back to Dashboard
                </button>
            </div>
        `;
        const analysisContent = analysisContainer.querySelector('#analysis-content');
        analysisContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Analyzing your test results...</p></div>';
        document.getElementById('testForm').insertAdjacentElement('afterend', analysisContainer);
        document.getElementById('testForm').classList.add('hidden');

        // Send answers to backend
        fetch('/tests/results', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(answerRequests)
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to submit test');
                return response.json();
            })
            .then(data => {
                // Render result in the same style as test
                let html = `<div class='mb-6 text-center'>
                <span class='text-2xl font-bold'>Score: ${data.score} / ${data.answerResponses.size}</span><br>
                <span class='text-lg font-semibold'>Correct Percent: ${data.correctPercent}%</span>
            </div>`;

                // Add performance section if available
                if (data.performance) {
                    html += `<div class='p-4 bg-blue-50 border-l-4 border-blue-400 rounded mb-6'>
                    <h3 class='font-bold text-lg mb-2'>Your Performance</h3>
                    <p class='text-gray-800'>${data.performance}</p>
                </div>`;
                }

                // Add view toggle switch
                html += `<div class='flex justify-center mb-6'>
                <div class='view-toggle'>
                    <button type='button' class='view-toggle-option active' data-view='simple'>Simple View</button>
                    <button type='button' class='view-toggle-option' data-view='detailed'>Detailed View</button>
                </div>
            </div>`;

                html += `<div id='resultQuestionsContainer'>`;
                data.answerResponses.forEach((q, idx) => {
                    html += `<div class='question-container ${q.isCorrect ? 'result-correct' : 'result-wrong'} mb-6'>`;
                    html += `<div class='question-header mb-3'>
                    <div class='flex items-center'>
                        <h3 class='text-xl font-semibold mr-4'>Question ${idx + 1}</h3>
                        <span class='badge bg-primary'>Part ${q.part}</span>
                    </div>
                    <button class='ml-auto bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded report-question-btn' data-question-id='${q.id}' data-question-text='${q.questionText}'>
                        <i class="fa fa-flag mr-1"></i> Report Question
                    </button>
                </div>`;

                    // Simple view elements (always visible)
                    html += `<div class='mb-4'>${q.questionText}</div>`;
                    html += `<div class='simple-answer-section'>
                    <div class='mt-2'><span class='font-semibold'>Your answer:</span>
                        <span class='${q.isCorrect ? 'text-green-600' : 'text-red-600'}'>${q.userAnswer || '-'}</span>
                    </div>
                    <div class='mt-2'><span class='font-semibold'>Correct answer:</span>
                        <span class='text-blue-600 font-bold'>${q.correctAnswer}</span>
                    </div>
                </div>`;

                    // Detailed view elements (hidden by default)
                    html += `<div class='detail-section hidden'>`;
                    if (q.passage) {
                        html += `<div class='passage-container'><h4 class='font-semibold mb-2'>Passage:</h4><div class='passage-text'>${q.passage}</div></div>`;
                    }
                    if (q.passageImageUrls && q.passageImageUrls.length > 0) {
                        html += `<div class='image-container'>`;
                        q.passageImageUrls.forEach(url => {
                            html += `<img src='${url}' alt='Question Image' style='margin-bottom: 0; max-width: 1000px; max-height: 700px; width: auto; height: auto; object-fit: contain;' />`;
                        });
                        html += `</div>`;
                    }

                    // All options with highlighting
                    html += `<div class='options-container mt-4'>`;
                    q.options.forEach(option => {
                        const isUser = q.userAnswer === option.key;
                        const isCorrect = q.correctAnswer === option.key;
                        html += `<div class='mb-2'>
                        <label class='option-label flex items-center ${isCorrect ? 'border-green-500 bg-green-50' : isUser ? (q.isCorrect ? 'border-green-300' : 'border-red-500 bg-red-50') : ''}'>
                            <input type='radio' disabled ${isUser ? 'checked' : ''} class='option-input'>
                            <span class='font-medium mr-2'>${option.key}:</span> ${option.value}
                            ${isCorrect ? "<span class='ml-2 text-green-600'>(Correct)</span>" : ''}
                            ${isUser && !isCorrect ? "<span class='ml-2 text-red-600'>(Your answer)</span>" : ''}
                        </label>
                    </div>`;
                    });
                    html += `</div>`;

                    // Explanation section
                    if (q.answerExplanation && q.answerExplanation.length > 0) {
                        html += `<div class='mt-4 text-gray-700'>
                        <span class='font-medium'>Explanation:</span>
                        <ul class='list-disc ml-6 mt-1'>
                            ${q.answerExplanation.map(exp => `<li>${exp}</li>`).join('')}
                        </ul>
                    </div>`;
                    }
                    html += `</div>`; // End detail-section
                    html += `</div>`; // End question-container
                });
                html += `</div>`;

                // Add recommendations section if available
                if (data.recommendations) {
                    html += `<div class='p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded mt-8 mb-4'>
                    <h3 class='font-bold text-lg mb-2'>Recommendations</h3>
                    <p class='text-gray-800'>${data.recommendations}</p>
                </div>`;
                }

                // Add reference URLs section if available
                if (data.referenceUrls && data.referenceUrls.length > 0) {
                    html += `<div class='p-4 bg-green-50 border-l-4 border-green-400 rounded mt-4'>
                    <h3 class='font-bold text-lg mb-2'>Reference Materials</h3>
                    <ul class='list-disc ml-6'>
                        ${data.referenceUrls.map(url => `
                            <li class='mb-2'>
                                <a href='${url}' target='_blank' rel='noopener noreferrer'
                                   class='text-blue-600 hover:text-blue-800 underline'>
                                    ${url}
                                </a>
                            </li>
                        `).join('')}
                    </ul>
                </div>`;
                }

                // Add download PDF button
                html += `<div class='text-center mt-8 mb-4'>
                    <button id='downloadPdfBtn' class='bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded text-lg font-semibold'>
                        <i class="fas fa-download mr-2"></i>Download PDF Report
                    </button>
                </div>`;

                analysisContent.innerHTML = html;

                // Add event listeners for view toggle
                const viewToggleOptions = document.querySelectorAll('.view-toggle-option');
                const detailSections = document.querySelectorAll('.detail-section');

                viewToggleOptions.forEach(option => {
                    option.addEventListener('click', function () {
                        const view = this.dataset.view;
                        viewToggleOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');

                        detailSections.forEach(section => {
                            section.classList.toggle('hidden', view === 'simple');
                        });
                    });
                });

                // Attach event listeners for report buttons
                document.querySelectorAll('.report-question-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        document.getElementById('reportQuestionId').value = this.getAttribute('data-question-id');
                        document.getElementById('reportCategory').value = '';
                        document.getElementById('reportDescription').value = '';
                        document.getElementById('reportFormMsg').textContent = '';
                        document.getElementById('categoryError').classList.add('hidden');
                        document.getElementById('descriptionError').classList.add('hidden');
                        document.getElementById('reportModal').classList.remove('hidden');
                    });
                });

                // Attach event listener for download PDF button
                const downloadPdfBtn = document.getElementById('downloadPdfBtn');
                if (downloadPdfBtn) {
                    downloadPdfBtn.addEventListener('click', function() {
                        downloadPdfBtn.disabled = true;
                        downloadPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating PDF...';
                        
                        // Gather user answers for PDF generation
                        const answerRequests = [];
                        document.querySelectorAll('.question-container').forEach((qBlock, idx) => {
                            const selectedOption = qBlock.querySelector('input[type="radio"]:checked');
                            const question = questions[idx];
                            answerRequests.push({
                                ...question,
                                userAnswer: selectedOption ? selectedOption.value : null
                            });
                        });

                        // Download PDF using test ID from the response
                        const testId = data.testId; // Assuming the response contains testId
                        if (!testId) {
                            alert('Test ID not found. Cannot download PDF.');
                            downloadPdfBtn.disabled = false;
                            downloadPdfBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Download PDF Report';
                            return;
                        }
                        
                        // Create a temporary link to download PDF
                        const link = document.createElement('a');
                        link.href = `/tests/${testId}/pdf`;
                        link.download = `toeic_test_result_${testId}.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Reset button state
                        downloadPdfBtn.disabled = false;
                        downloadPdfBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Download PDF Report';
                    });
                }

                document.getElementById('back-to-dashboard-container').classList.remove('hidden');
                document.getElementById('analysis-dashboard-btn').onclick = goToDashboard;
            })
            .catch(err => {
                analysisContent.innerHTML = `<div class='text-red-600'>Error: ${err.message}</div>`;
            });
    }

    // Navigation functions
    function goToDashboard() {
        window.location.href = '/chat';
    }

    // Warn user before leaving/reloading the page during the test
    window.addEventListener('beforeunload', function (e) {
        const message = 'Are you sure you want to leave? Your test progress will be lost!';
        e.preventDefault();
        e.returnValue = message;
        return message;
    });

    // Modal logic
    (function () {
        const modal = document.getElementById('reportModal');
        const closeBtn = document.getElementById('closeReportModal');
        closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.add('hidden');
        });
        document.getElementById('reportForm').addEventListener('submit', function (e) {
            e.preventDefault();
            // Validation
            let valid = true;
            const questionId = document.getElementById('reportQuestionId').value;
            const category = document.getElementById('reportCategory').value;
            const description = document.getElementById('reportDescription').value.trim();
            if (!questionId || questionId === 'undefined' || isNaN(Number(questionId))) {
                document.getElementById('reportFormMsg').textContent = 'Invalid question. Please try again.';
                document.getElementById('reportFormMsg').className = 'text-red-600 mb-2';
                return;
            }
            if (!category) {
                document.getElementById('categoryError').classList.remove('hidden');
                valid = false;
            } else {
                document.getElementById('categoryError').classList.add('hidden');
            }
            if (!description) {
                document.getElementById('descriptionError').classList.remove('hidden');
                valid = false;
            } else {
                document.getElementById('descriptionError').classList.add('hidden');
            }
            if (!valid) return;
            // Prepare data
            const data = {
                questionId: questionId,
                category: category,
                description: description
            };
            // Submit to backend
            fetch('/reports', {
                method: 'POST',
                body: new URLSearchParams(data),
            }).then(async resp => {
                if (resp.ok) {
                    document.getElementById('reportFormMsg').textContent = 'Report submitted successfully!';
                    document.getElementById('reportFormMsg').className = 'text-green-600 mb-2';
                    setTimeout(() => modal.classList.add('hidden'), 1200);
                } else {
                    const err = await resp.text();
                    document.getElementById('reportFormMsg').textContent = err || 'Failed to submit report.';
                    document.getElementById('reportFormMsg').className = 'text-red-600 mb-2';
                }
            }).catch(() => {
                document.getElementById('reportFormMsg').textContent = 'Failed to submit report.';
                document.getElementById('reportFormMsg').className = 'text-red-600 mb-2';
            });
        });
    })();
</script>

</body>
</html>
